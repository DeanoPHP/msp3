{% extends "base.html" %}
{% block title %} Profile page {{ user["profile"].name }} {% endblock %}
{% block main %}
<div class="main-container">
    <div class="left-content">
        <div class="profile-image">
            {% if user.profile.profile_image %}
            <img class="profile-image" src="data:image/jpeg;base64,{{ user['profile']['profile_image'] }}"
                alt="Profile Image" />
            {% else %}
            <img class="profile-image" src="{{ url_for('static', filename='images/no-image.jpeg') }}" alt="">
            {% endif %}
        </div>

        {% if user %}
        <h5 class="coral">Welcome, {{ user['profile'].name }}</h5>

        <ul>
            <p><b>Username:</b> {{ user["username"] }}</p>
            <p><b>Email:</b> {{ user['email'] }}</p>
            <p><b>Phone:</b> {{ user['profile'].phoneNo }}</p>
            <p><b>bio:</b> {{ user['profile'].bio }}</p>
            {% if session["user"] == user["username"] %}
            <p><a class="modal-trigger" href="#edit-details">Edit Details</a></p>
            {% if not business %}
            <p><a class="modal-trigger" href="#add-business">Add a business</a></p>
            {% endif %}
            {% endif %}
            <p><a class="btn red modal-trigger" href="#deleteModal">Delete Account</a></p>
        </ul>

        {% else %}
        <h5>User profile not available</h5>
        {% endif %}
    </div>

    <!-- Display business data -->
    <div class="right-content">
        <div class="business-container">
            <div class="business-left">
                {% if business %}

                <h5 class="coral">{{ business['company_name'] }}</h5>
                <p><b>Business Overview:</b> {{ business['description'] }}</p>

                <!-- images go here -->
                <div class="row">
                    <div class="business_images_container col s12">
                        <div class="row">
                            {% for image in business['images'] %}
                            <div class="col s4 m6">
                                <img class="business_images" src="data:image/jpeg;base64,{{ image }}"
                                    alt="Business Image">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Reviews area -->
                <h5>{{ business["company_name"] }} Reviews</h5>

                <!-- Review form -->
                <div class="row">
                    <form class="col s12"
                        action="{{ url_for('main.add_review', username=username, business_id=business['owner_id'] if business and business['_id'] else 'none') }}"
                        method="POST">
                        <div class="row">
                            <div class="input-field col s9 review-textarea">
                                <textarea id="reviews" name="reviews" class="materialize-textarea" required></textarea>
                                <label for="reviews">Write a review for {{ business['company_name'] }}</label>
                            </div>

                            <input type="hidden" name="datefeild" id="datefeild">

                            <button class="btn waves-effect waves-light s3 review-button" type="submit" name="action"
                                id="review-submit">Add Review
                                <i class="material-icons right">send</i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Display reviews -->
                <!-- Display reviews -->
                <ul>
                    {% for review in reviews %}
                    <div class="review-container">
                        <div class="row">
                            <div class="col s2">
                                <img class="review-image" src="data:image/jpeg;base64, {{ review['profile_image'] }}"
                                    alt="profile image">
                            </div>
                            <div class="col s8 review">{{ review['text'] }}</div>
                            <div class="col s1 edit">
                                <a class="modal-trigger" href="#edit-review" data-id="{{ review['_id'] }}"
                                    data-text="{{ review['text'] }}">Edit</a>
                            </div>
                            <div class="col s1 delete">
                                <form action="{{ url_for('main.review_delete', review_id=review['_id'] ) }}"
                                    method="POST">
                                    <input type="hidden" name="profile_username" value="{{ user['username'] }}">
                                    <button class="button1-style" type="submit">X</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <li>No reviews yet for this profile.</li>
                    {% endfor %}
                </ul>

                {% else %}
                <h5>You do not have a business to display.</h5>
                {% endif %}
            </div>
            <div class="business-right">
                {% if business %}
                <div class="business-logo"></div>
                <p><b>Category:</b> {{ business['category'] }}</p>
                <p><b>Location:</b> {{ business['location'] }}</p>
                <p><b>Email:</b> {{ business['contact_info']['email'] }}</p>
                <p><b>Phone:</b> {{ business['contact_info']['phone'] }}</p>
                <p><b>Website:</b> <a href="https://{{ business['contact_info']['website'] }}" target="_blank">{{
                        business['contact_info']['website'] }}</a></p>
                <p><a class="modal-trigger" href="#create-deal">Create a deal</a></p>
                <p><a class="btn red modal-trigger" href="#deleteBusinessModal">Delete Business</a></p>
                {% else %}
                <h5>No business info</h5>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal form to edit profile info-->
    <div id="edit-details" class="modal">
        <div class="modal-content">
            <h4>Edit Your Details</h4>
            <form action="{{ url_for('main.edit_details', user_id=user['_id']) }}" method="POST"
                enctype="multipart/form-data">

                <div class="input-field col s12">
                    <i class="material-icons prefix">U</i>
                    <input type="text" name="username" id="username-input" class="autocomplete"
                        value="{{ user['username'] }}">
                    <label for="username-input">Username</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">E</i>
                    <input type="email" name="email" id="email-input" class="autocomplete" value="{{ user['email'] }}">
                    <label for="email-input">Email</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">N</i>
                    <input type="text" name="name" id="name-input" class="autocomplete"
                        value="{{ user['profile']['name'] }}">
                    <label for="name-input">Name</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">P</i>
                    <input type="text" name="postcode" id="postcode-input" class="autocomplete"
                        value="{{ user['profile']['postcode'] }}">
                    <label for="postcode-input">Postcode</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">B</i>
                    <input type="text" name="bio" id="bio-input" class="autocomplete"
                        value="{{ user['profile']['bio'] }}">
                    <label for="bio-input">Bio</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">T</i>
                    <input type="tel" name="phoneNo" id="phoneNo-input" class="autocomplete"
                        value="{{ user['profile']['phoneNo'] }}">
                    <label for="phoneNo-input">Phone Number</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">F</i>
                    <input type="file" name="profile_image" id="profile_image" class="autocomplete">
                    <label for="phoneNo-input">Change Image</label>
                </div>

                <button class="btn waves-effect waves-light" type="submit" name="action">Submit
                    <i class="material-icons right">send</i>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal for adding a business -->
    <div id="add-business" class="modal">
        <div class="modal-content">
            <h4>Add Your Business</h4>
            <form action="{{ url_for('main.add_business', user_id=user['_id']) }}" method="POST"
                enctype="multipart/form-data">
                <div class="input-field col s12">
                    <i class="material-icons prefix">C</i>
                    <input type="text" name="company_name" id="autocomplete-input" class="autocomplete">
                    <label for="autocomplete-input">Company Name</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">D</i>
                    <input type="text" name="description" id="autocomplete-input" class="autocomplete">
                    <label for="autocomplete-input">Description</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">L</i>
                    <input type="text" name="location" id="autocomplete-input" class="autocomplete">
                    <label for="autocomplete-input">Location</label>
                </div>

                <div class="input-field col s12">
                    <select name="category">
                        <option value="" disabled selected>Choose one that best fits your business</option>
                        <option value="cleaning services">Cleaning Services</option>
                        <option value="gardening">Gardening & Landscape</option>
                        <option value="hair and beauty">Hair & Beauty</option>
                        <option value="child care and education">Child care & education</option>
                        <option value="building and trades">Building & Trades</option>
                        <option value="health fitness and sport">Health, Fitness, & Sport</option>
                        <option value="retail and crafts">Retail, & Crafts</option>
                        <option value="professional services">Professional Services</option>
                    </select>
                </div>

                <div class="file-field input-field">
                    <div class="btn">
                        <span>File</span>
                        <input type="file" name="business_images" multiple required>
                    </div>
                    <div class="file-path-wrapper">
                        <input class="file-path validate" name="business_images" type="text"
                            placeholder="Upload one or more files">
                    </div>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">E</i>
                    <input type="email" name="email" id="autocomplete-input" class="autocomplete">
                    <label for="autocomplete-input">Email</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">P</i>
                    <input type="tel" name="phone" id="autocomplete-input" class="autocomplete">
                    <label for="autocomplete-input">Phone</label>
                </div>

                <div class="input-field col s12">
                    <i class="material-icons prefix">W</i>
                    <input type="text" name="website" id="autocomplete-input" class="autocomplete">
                    <label for="autocomplete-input">Website</label>
                </div>

                <button class="btn waves-effect waves-light" type="submit" name="action">Submit
                    <i class="material-icons right">Add</i>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal for editing reviews -->
    <div id="edit-review" class="modal">
        <div class="modal-content">
            <h4>Edit Your Review</h4>
            <form action="" id="edit-review-form" method="POST">
                <div class="row">
                    <div class="input-field col s9 review-textarea">
                        <textarea id="edit-review-text" name="review" class="materialize-textarea" value=""
                            required></textarea>
                        <label for="review"></label>
                    </div>

                    <input type="hidden" name="datefeild" id="datefeild">

                    <button class="btn waves-effect waves-light s3 review-button" type="submit" name="action"
                        id="review-submit">Update Review
                        <i class="material-icons right">send</i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete business modal -->
    <div id="deleteBusinessModal" class="modal">
        <div class="modal-content">
            <h4>Confirm Business Account Deletion</h4>
            <p>Are you sure you want to delete your business account?</p>
        </div>
        <div class="modal-footer">
            <form method="POST" action="{{ url_for('main.delete_business', business_user_id=user['_id']) }}"
                style="display: inline;">
                <button type="submit" name="confirm" value="yes" class="btn red">Yes, Delete</button>
            </form>
            <a class="modal-close btn grey">Cancel</a>
        </div>
    </div>
</div>
{% endblock %}